<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Customer Lookup</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .record { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 10px; }
    .label { font-weight: bold; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h2>Customer Details Lookup</h2>

<div id="searchContainer">
  <input id="phoneInput" placeholder="Enter phone (e.g., 0412345678)" style="width: 300px; padding: 8px;">
  <button onclick="lookup()">Search</button>
</div>

<div id="result"></div>

<script>
let database = [];

// Normalize phone: 0412345678, +61412345678, 61412345678 all -> 0412345678
function normalizePhone(raw) {
  if (!raw && raw !== 0) return "";
  let digits = String(raw).replace(/\D+/g, "");
  if (digits.startsWith("61") && digits.length >= 9) {
    digits = "0" + digits.slice(2);
  } else if (digits.startsWith("0") && digits.length >= 9) {
    digits = digits;
  }
  return digits;
}

// Flexible comparison: exact or last 9 digits
function phoneMatches(candidate, target) {
  if (!candidate || !target) return false;
  if (candidate === target) return true;
  return candidate.slice(-9) === target.slice(-9);
}

// Load JSON database
fetch("data.json")
  .then(res => res.json())
  .then(json => {
    database = json.map(r => ({
      __original: r,
      mobile_phone_norm: normalizePhone(r.mobile_phone),
      home_phone_norm: normalizePhone(r.home_phone),
      business_phone_norm: normalizePhone(r.business_phone),
      other_phone_norm: normalizePhone(r.other_phone)
    }));

    // Check URL query param ?phone=...
    const params = new URLSearchParams(window.location.search);
    if (params.has("phone")) {
      const phone = params.get("phone");
      document.getElementById("phoneInput").value = phone;
      document.getElementById("searchContainer").classList.add("hidden"); // hide input
      lookup();
    }
  });

// Lookup function
function lookup() {
  const input = document.getElementById("phoneInput").value.trim();
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";
  if (!input) {
    resultDiv.innerHTML = "<p>Please enter a phone number.</p>";
    return;
  }
  const normInput = normalizePhone(input);

  const found = database.find(item => {
    const fields = [
      item.mobile_phone_norm,
      item.home_phone_norm,
      item.business_phone_norm,
      item.other_phone_norm
    ];
    return fields.some(f => phoneMatches(f, normInput));
  });

  if (!found) {
    resultDiv.innerHTML = `<p>No record found for <strong>${input}</strong>.</p>`;
    return;
  }

  const record = found.__original;
  let html = `<div class='record'><h3>${record.display_name || "(no display_name)"}</h3>`;
  for (const key in record) {
    const val = record[key];
    if (val === null || val === undefined || String(val).trim() === "") continue;
    html += `<p><span class='label'>${key}:</span> ${String(val).replace(/\n/g,"<br>")}</p>`;
  }
  html += `</div>`;
  resultDiv.innerHTML = html;
}
</script>

</body>
</html>
